<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>EBNF Railroad Visualizer</title>
		<link rel="icon" href="/favicon.svg" />
		<link rel="stylesheet" type="text/css" href="./css/railroad.css">
		<link rel="stylesheet" href="./css/styles.css">
		<script type="module">
     		import { Diagram, EXPAND_ALL } from "./out/Diagram.js";

			const DIAGRAM_GENERATION_TIMEOUT = 100;
			const toExtend = new Set();

			/**
			 * Asynchronously generate a diagram from a given grammar.
			 * @param {string} grammar - The grammar to generate a diagram from.
			 * @returns {Promise<Diagram>} - The generated diagram.
			 * @throws {Error} - If the diagram could not be generated or took longer than the timeout.
			 */
			async function asyncGenerateDiagram(grammar) {
				console.debug("Generating diagramâ€¦");
				return new Promise((resolve, reject) => {
					// Timeout to prevent blocking the UI or freezing the browser
					setTimeout(() => {
						console.debug("Generation Timeout");
						reject()
					}, DIAGRAM_GENERATION_TIMEOUT);

					try {
						// Generate the diagram
						const d = Diagram.fromString(grammar);
						resolve(d);
					} catch (e) {
						reject(e);
					}
				});
			}

			function generateDiagram() {
				const ebnfGrammarValue = document.querySelector("textarea[name=ebnf_grammar]").value;
				if (ebnfGrammarValue.trim() === "") {
					console.debug("Nothing was entered into the textarea.")
					return;
				}

				asyncGenerateDiagram(ebnfGrammarValue).then((diagram) =>
				{
					// Insert the diagram into the HTML
					document.getElementById("visualized_ebnf").innerHTML = diagram.toSvg(Array.from(toExtend));

					// Add a click event listener to the diagram
					document.addEventListener("click", (event) => {
						// Add a click event listener to the NTS to extend
						document.querySelectorAll(".non-terminal").forEach((element) => {
							element.addEventListener("click", (event) => {
								// Get ID from inner child with tag "title"
								const title = event.currentTarget.querySelector("title");
								const id = title.textContent.trim();

								// Add the ID to the set of non-terminals to extend
								toExtend.add(parseInt(id));
								console.debug(`Expanding NTS with ID '${id}'`);

								// Generate the diagram again
								generateDiagram();
							});
						});

						// TODO: Add a click event listener to the Groups to shrink the NTS it encloses
					});
				}).catch(e => console.warn(`An error occurred while generating the diagram: ${e}`));
			}

			/**
			 * Handle the generation of a diagram from the entered grammar.
			 */
			window.handleGenerateDiagram = function() {
				toExtend.clear();
				generateDiagram();
			}


			/**
			 * Handle the click event of the "Collapse All" button.
			 */
			window.onCollapseAll = function() {
				console.debug("Collapsing all non-terminals");
				// Remove all non-terminals to extend
				toExtend.clear();
				// Generate the diagram again
				generateDiagram();
			}

			/**
			 * Handle the click event of the "Expand All" button.
			 */
			window.onExpandAll = function() {
				console.debug("Expanding all non-terminals");
				// Remove all current "toExpand" NTS
				console.clear();
				// Add special number"for expanding all
				toExtend.add(EXPAND_ALL);
				// Generate the diagram again
				generateDiagram();

			}
		</script>
	</head>
	<body>
		<h1>EBNF Visualizer</h1>
		<h2>Grammar</h2>
		<textarea autofocus="true" name="ebnf_grammar" placeholder="EBNF-Grammar in Wirth Syntax Notation" oninput="handleGenerateDiagram()"></textarea>

		<h2>Railroad Diagram</h2>
		<button onclick="onExpandAll();">Expand All</button>
		<button onclick="onCollapseAll();">Collapse All</button>
    	<div id="visualized_ebnf">
			<!-- Diagram will be inserted here -->
		</div>
	</body>
</html>