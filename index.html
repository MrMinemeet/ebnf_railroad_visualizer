<!DOCTYPE html>
<html lang="en">
  <head>
    <title>EBNF Railroad Visualizer</title>
    <meta charset="UTF-8">
    <meta name="description" content="A visualizer for EBNF grammars using railroad diagrams.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="./images/favicon.svg" />
    <link rel="stylesheet" type="text/css" href="./css/railroad.css">
    <link rel="stylesheet" href="./css/styles.css">
    <script src="./out/external/lz-string.js"></script>
    <script type="module">
      import { Diagram } from "./out/Diagram.js";
      import { asyncGenerateDiagram, asyncGenerateGrammar, asyncCssToString, base64ToBase64Url, getNonAsciiChars, titleToPath } from "./out/ChooChoo.js";
      let toExtend = new Set();


			window.generateDiagram = function() {
        const error_message_container = document.getElementById("error_message");
        const diagram_container = document.getElementById("visualized_ebnf");
				const ebnfGrammarValue = document.querySelector("textarea[name=ebnf_grammar]").value;

				if (ebnfGrammarValue.trim() === "") {
					console.debug("Nothing was entered into the textarea.")
          diagram_container.style.display = "none";
					return;
				}
        let nonAscii = getNonAsciiChars(ebnfGrammarValue);
        if (nonAscii.size > 0) {
          console.warn("The following non-ASCII characters were detected in the grammar: ", nonAscii);
          error_message_container.innerHTML = `<p>Non-ASCII character(s) detected: ${Array.from(nonAscii).join(", ")}</p>`;
          error_message_container.style.display = "block";
          diagram_container.style.display = "none";
          return;
        }

				asyncGenerateDiagram(ebnfGrammarValue).then((diagram) =>
				{
					// Insert the diagram into the HTML
					diagram_container.innerHTML = diagram.toSvg(Array.from(toExtend));

          // Add a click event listener to the NTS to extend
          document.querySelectorAll(".non-terminal").forEach((element) => {
            element.addEventListener("click", (event) => {
              // Get ID from inner child with tag "title"
              const title = event.currentTarget.querySelector("title");
              const pathTitle = title.textContent.trim();

              // Add the ID to the set of non-terminals to extend
              // TODO: Adjust
              toExtend.add(titleToPath(pathTitle));
              console.debug(`Expanding NTS on path '${pathTitle}'`);

              // Generate the diagram again
              generateDiagram();
              updateURL();
            });
          });

          // Add a click event listener to the comment to collapse
          document.querySelectorAll("g.comment").forEach((element) => {
            element.addEventListener("click", (event) => {
              // Get ID from inner child with tag "title"
              const title = event.currentTarget.querySelector("title");
              const pathTitle = title.textContent.trim();

              // Add the ID to the set of non-terminals to extend
              // TODO: Adjust
              console.debug(`Collapsing NTS on path '${pathTitle}'`);

              // Remove the pathTitle and all children that start with it from the set
              // TODO: Either remove all children or the entry for the path itself
              toExtend = new Set(Array.from(toExtend).filter((x) => !x.join('-').startsWith(pathTitle)));

              // Generate the diagram again
              generateDiagram();
              updateURL();
            });
          });

          // Hide the error message container
          error_message_container.style.display = "none";
          diagram_container.style.display = "block";
				}).catch(e => {
          const PRODUCTION_NOT_FOUND_REGEX = /^Production '([^']*)' not found$/

          console.warn(`An error occurred while generating the diagram: ${e}`)
          if (!e.message.includes("but found") && 
            !e.message.includes("Unknown character") &&
            !PRODUCTION_NOT_FOUND_REGEX.test(e.message)
            ) {
            console.warn(e.stack)
          }
          
          error_message_container.innerHTML = `<p>${e}</p>`;
          error_message_container.style.display = "block";

          // Don't hide graph if it is a "production X not found" error
          if (!PRODUCTION_NOT_FOUND_REGEX.test(e.message)) {
            diagram_container.style.display = "none";
          }
        });
			}

			/**
			 * Handle the generation of a diagram from the entered grammar.
			 */
			window.handleGenerateDiagram = function() {
				toExtend.clear();
				generateDiagram();
        updateURL();
			}


			/**
			 * Handle the click event of the "Collapse All" button.
			 */
			window.onCollapseAll = function() {
				console.debug("Collapsing all non-terminals");
				// Remove all non-terminals to extend
				toExtend.clear();
				// Generate the diagram again
				generateDiagram();
        updateURL();
			}

      /**
       * Handle the click event of the "Expand All" button.
       */
      window.onExpandAll = function() {		
        const ebnfGrammarValue = document.querySelector("textarea[name=ebnf_grammar]").value;
        if (ebnfGrammarValue.trim() === "") return;
        console.debug("Expanding all non-erminals");		
        // Replace currently "toExtend" with all IDs that are expandable
        asyncGenerateGrammar(ebnfGrammarValue).then((g) => {
          // TODO: Adjust
          // toExtend = new Set(g.expandableIDs);
          generateDiagram();
          updateURL();
        }).catch((e) =>  console.warn(e));
        // Generate the diagram again
      }

      window.onStoreDiagram = function() {
        // Get child of "visualized_ebnf" id
        const svgHtml = document.getElementById("visualized_ebnf").children[0];
        if(svgHtml === undefined) {
          console.warn("No diagram to store.");
          return;
        }        
        console.debug("Storing diagram as SVGâ€¦");

        // Add XML declarations to the SVG
        svgHtml.setAttribute("xmlns", "http://www.w3.org/2000/svg");
        svgHtml.setAttribute("shape-rendering", "geometricPrecision");
        svgHtml.setAttribute("text-rendering", "geometricPrecision");
        svgHtml.setAttribute("image-rendering", "optimizeQuality");

        // Get the style of the diagram (./css/railroad.css)
        const styleSheet = document.styleSheets[0];

        asyncCssToString(styleSheet).then((cssString) => {
          // Add the CSS to the SVG as a style element
          const styleElement = document.createElement("style");
          styleElement.textContent = cssString;
          svgHtml.prepend(styleElement);

          // Save SVG HTML as file
          const blob = new Blob([svgHtml.outerHTML], {type: "image/svg+xml"});
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "railroad-diagram.svg";
          a.click();
        });
      }

      // Update URL with grammar and expand numbers
      window.updateURL = function() {
        let url = new URL(window.location.href)

        let grammar = document.querySelector("textarea[name=ebnf_grammar]").value;
        if (grammar.trim() === "") {
          // Remove grammar from URL
          url.searchParams.delete("grammar");
        } else {
          //  Encode grammar to base64URL and add to URL
          const compressedGrammar = LZString.compressToBase64(grammar);
          console.debug(`Compressed grammar from ${grammar.length} to ${compressedGrammar.length} characters`);
          const grammarBase64 = base64ToBase64Url(compressedGrammar);
          url.searchParams.set("grammar", grammarBase64);
        }

        if (toExtend.size === 0) {
          // Remove expand numbers from URL
          url.searchParams.delete("expand");
        } else {
          // Add expand numbers to URL
          url.searchParams.set("expand", Array.from(toExtend).join("|"));
        }

        // Replace URL
        window.history.replaceState({}, "", url.toString());
      }
    </script>
  </head>
  <body>
    <h1>EBNF Visualizer</h1>
    <a loading="lazy" id="repository_reference" href="https://github.com/MrMinemeet/ebnf_railroad_visualizer" target="_blank"><img src="./images/github-mark.svg" alt="GitHub Invertocat linking to the repository"></a>
    
    <h2>Grammar</h2>
      <textarea autofocus="true" id="userInput" name="ebnf_grammar" placeholder="EBNF-Grammar in Wirth Syntax Notation" oninput="handleGenerateDiagram()"></textarea>
      <div id="error_message">
        <!-- Error message will be inserted here -->
      </div>
    </div>

    <h2>Railroad Diagram</h2>
    <button onclick="onExpandAll();">Expand All</button>
    <button onclick="onCollapseAll();">Collapse All</button>
    <button onclick="onStoreDiagram();">Store Diagram</button>
    <div id="visualized_ebnf">
      <!-- Diagram will be inserted here -->
    </div>

    <script type="module" async defer>
      import { base64UrlToBase64 } from "./out/ChooChoo.js";
      // Try to get grammar from URL
      let urlGrammar = new URLSearchParams(window.location.search).get("grammar");
      if(urlGrammar) {
        const grammar = LZString.decompressFromBase64(base64UrlToBase64(urlGrammar));
        document.querySelector("textarea[name=ebnf_grammar]").value = grammar;
      }

      // Try to get toExpand numbers from URL
      let urlToExpandNumbers = undefined;
      // TODO: Adjust
      /*
      let urlToExpandNumbers = new URLSearchParams(window.location.search).get("expand");
      if(urlToExpandNumbers) {
        let toExpandNumbers = urlToExpandNumbers.split("|").map(Number);
        toExtend = new Set(toExpandNumbers);
      }
      */

      if (urlGrammar || urlToExpandNumbers) {
        // Generate diagram when something is in the URL
        setTimeout(function() {
            if (typeof window.generateDiagram === 'function') {
                window.generateDiagram();
            } else {
                console.error('generateDiagram function is not available');
            }
        }, 100); // 100ms delay
      }
    </script>
  </body>
</html>