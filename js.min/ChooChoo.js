"use strict";var j=Object.defineProperty;var l=(e,t)=>j(e,"name",{value:t,configurable:!0});var g=function(e,t,n,o){function r(a){return a instanceof n?a:new n(function(i){i(a)})}return l(r,"adopt"),new(n||(n=Promise))(function(a,i){function s(u){try{d(o.next(u))}catch(h){i(h)}}l(s,"fulfilled");function c(u){try{d(o.throw(u))}catch(h){i(h)}}l(c,"rejected");function d(u){u.done?a(u.value):r(u.value).then(s,c)}l(d,"step"),d((o=o.apply(e,t||[])).next())})};import{Diagram as _}from"./Diagram.js";import{Grammar as V}from"./Grammar.js";import*as y from"https://cdn.jsdelivr.net/npm/d3@7/+esm";import E from"./external/lz-string.js";const z=100,O=100,A=4,N="grammarlz",C="grammar",R="expandlz",L="expand",G="start";let p,v,x,T,M,U,b="",q;export function install(e){let t=document.getElementById("error_message");if(t==null)throw new Error("Failed to find 'error_message' container");if(p=t,t=document.getElementById("visualized-ebnf"),t==null)throw new Error("Failed to find 'visualized-ebnf' container");if(v=t,t=document.querySelector("textarea[name=ebnf_grammar]"),t==null)throw new Error("Failed to find 'ebnf_grammar' textarea");if(x=t,t=document.querySelector("#start-symbol"),t==null)throw new Error("Failed to find 'start-symbol' select");M=t,T=document.querySelector(".start-symbol-drop-down"),e.currentStartSymbolName="",e.toExtend=new Set,e.generateDiagram=m,e.handleGenerateDiagram=W,e.handleStartSymbolSelection=H,e.onCollapseAll=Q,e.onExpandAll=Y,e.exportSvg=()=>exportSvg(e.toExtend),e.exportPng=()=>exportPng(e.toExtend),e.addEventListener("resize",e.updateSvgViewBoxSize)}l(install,"install");function X(){var e;if(b.trim().length===0)return;const t=y.select(".railroad-diagram");let n=Array.from((e=t.node())===null||e===void 0?void 0:e.querySelectorAll("title")).filter(c=>c.innerHTML===b)[0].parentNode;if(n==null)throw new Error("Failed to find parent of focus element");n.tagName==="g"&&n.classList.contains("comment")&&(n=n.parentNode);const o=n.getBBox(),r=o.x+o.width/2,a=o.y+o.height/2,i=t.node().viewBox.baseVal,s=y.zoomIdentity.translate(i.width/2-r,i.height/2-a);console.debug(`Box center: (${r}, ${a})`),console.debug(`New transform: ${s}`),t.call(U.transform,s),b=""}l(X,"focusElementSvg");function W(){m(),f(),ee()}l(W,"handleGenerateDiagram");function Q(){window.toExtend.clear(),m(),f()}l(Q,"onCollapseAll");function Y(){const e=x.value;e.trim()!==""&&(console.debug("Expanding all non-erminals"),asyncString2Diagram(e,window.currentStartSymbolName).then(t=>{window.toExtend=t.getAllNtsPaths(),m(),f()}).catch(t=>console.warn(t)))}l(Y,"onExpandAll");function K(){var e;const t=document.getElementsByClassName("railroad-diagram")[0];t.removeAttribute("width"),t.removeAttribute("height"),te();const n=y.select(".railroad-diagram"),o=Array.from((e=n.node())===null||e===void 0?void 0:e.children),r=n.append("g");o.forEach(i=>{var s;(s=r.node())===null||s===void 0||s.appendChild(i)}),U=y.zoom().scaleExtent([.1,8]).on("zoom",a),n.call(U);function a({transform:i}){r.attr("transform",i.toString())}l(a,"zoomed")}l(K,"injectD3");function m(){if(x.value.trim()===""){console.debug("Nothing was entered into the textarea."),v.style.display="none";return}const e=x.value,t=getNonAsciiChars(e);if(t.size>0){console.warn("The following non-ASCII characters were detected in the grammar: ",t),p.innerHTML=`<p>Non-ASCII character(s) detected: ${Array.from(t).join(", ")}</p>`,p.style.display="block",v.style.display="none";return}asyncString2Grammar(e).then(n=>(window.currentStartSymbolName=setStartSymbols(n.getStartSymbols(),window.currentStartSymbolName)||"",asyncGrammar2Diagram(n,window.currentStartSymbolName))).then(n=>{v.innerHTML=n.toSvg(window.toExtend),K(),document.querySelectorAll(".non-terminal").forEach(o=>Z(o)),document.querySelectorAll("g.comment").forEach(o=>J(o)),X(),p.style.display="none"}).catch(n=>{const o=/^Production '([^']*)' not found, but required for expansion$/;console.warn(`An error occurred while generating the diagram: ${n}`),!n.message.includes("but found")&&!n.message.includes("Unknown character")&&!o.test(n.message)&&console.warn(n.stack),p.innerHTML=`<p>${n}</p>`,p.style.display="block",o.test(n.message)||(v.innerHTML="")})}l(m,"generateDiagram");function Z(e){e.addEventListener("click",t=>{var n,o,r,a,i,s;if(t.currentTarget==null){console.warn("Failed to find current target.");return}if(t.ctrlKey){const c=(o=(n=t.currentTarget.querySelector("text"))===null||n===void 0?void 0:n.textContent)!==null&&o!==void 0?o:"";if(M==null){console.warn("Failed to find start symbol select.");return}M.value=c,H()}else{const c=t.currentTarget.querySelector("title"),d=(a=(r=c?.textContent)===null||r===void 0?void 0:r.trim())!==null&&a!==void 0?a:"",u=title2Path(d);if(u.length>=_.MAX_EXPANSION_DEPTH){console.warn(`Cannot expand NTS on path '${d}'. Depth limit reached!`),alert("Max. expansion depth reached!");return}window.toExtend.add(u),console.debug(`Expanding NTS on path '${d}'`),b=(s=(i=t.currentTarget.querySelector("title"))===null||i===void 0?void 0:i.innerHTML)!==null&&s!==void 0?s:"",m(),f()}})}l(Z,"injectCollapseListener");function J(e){e.addEventListener("click",t=>{var n,o,r,a;const i=t.currentTarget.querySelector("title"),s=(o=(n=i?.textContent)===null||n===void 0?void 0:n.trim())!==null&&o!==void 0?o:"";console.debug(`Collapsing NTS on path '${s}'`),window.toExtend=new Set(Array.from(window.toExtend).filter(c=>c.join("-")!==s)),b=(a=(r=t.currentTarget.querySelector("title"))===null||r===void 0?void 0:r.innerHTML)!==null&&a!==void 0?a:"",m(),f()})}l(J,"injectExpandListener");function ee(){clearTimeout(q),q=setTimeout(()=>{try{const e=window.toExtend.size;window.toExtend=filterInvalidPaths(x.value,window.toExtend),e!==window.toExtend.size?(console.debug(`Cleaned up ${e-window.toExtend.size} paths`),m(),f()):console.debug("No paths to clean up")}catch(e){console.warn(`An error occurred while cleaning up paths (this can likely be ignored): ${e}`)}},5e3)}l(ee,"resetPathCleanupTimer");export function isUppercase(e){return/^\p{Lu}/u.test(e)}l(isUppercase,"isUppercase");export function isQuote(e){return e==='"'||e==="\u201E"||e==="\u201C"}l(isQuote,"isQuote");export function asyncString2Diagram(e,t){return g(this,void 0,void 0,function*(){return console.debug("Generating diagram\u2026"),new Promise((n,o)=>{asyncString2Grammar(e).then(r=>{n(asyncGrammar2Diagram(r,t))}).catch(o)})})}l(asyncString2Diagram,"asyncString2Diagram");export function asyncGrammar2Diagram(e,t){return g(this,void 0,void 0,function*(){return console.debug("Generating diagram\u2026"),new Promise((n,o)=>{const r=setTimeout(()=>{console.debug("Generation Timeout"),o()},z);try{const a=_.fromGrammar(e,t);console.debug("Diagram generated successfully."),clearTimeout(r),n(a)}catch(a){clearTimeout(r),o(a)}})})}l(asyncGrammar2Diagram,"asyncGrammar2Diagram");export function asyncString2Grammar(e){return g(this,void 0,void 0,function*(){return console.debug("Scanning/Parsing grammar"),new Promise((t,n)=>{const o=setTimeout(()=>{console.debug("Generation Timeout"),n()},z);try{const r=V.fromString(e);console.debug("Grammar scanned/parsed successfully."),clearTimeout(o),t(r)}catch(r){clearTimeout(o),n(r)}})})}l(asyncString2Grammar,"asyncString2Grammar");export function asyncCss2String(e){return g(this,void 0,void 0,function*(){return new Promise((t,n)=>{try{t(Array.from(e.cssRules).map(o=>o.cssText).filter(o=>!o.includes("hover")).join(`
`))}catch(o){n(o)}})})}l(asyncCss2String,"asyncCss2String");export function base64ToBase64Url(e){return e.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}l(base64ToBase64Url,"base64ToBase64Url");export function base64UrlToBase64(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");for(;t.length%4!==0;)t+="=";return t}l(base64UrlToBase64,"base64UrlToBase64");export function getNonAsciiChars(e,t=!1){return new Set(e.split("").filter(n=>n.charCodeAt(0)>(t?255:127)))}l(getNonAsciiChars,"getNonAsciiChars");export function title2Path(e){return e.split("-").map(Number)}l(title2Path,"title2Path");export function addValuesToUrl(e,t,n,o){const r=new URL(e);if(o&&o.trim()!==""&&(r.searchParams.delete(G),o.trim()!==""&&r.searchParams.set(G,o)),t&&(r.searchParams.delete(N),r.searchParams.delete(C),t.trim()!==""))if(t.length>O){const a=E.compressToBase64(t);r.searchParams.set(N,base64ToBase64Url(a))}else{const a=btoa(t);r.searchParams.set(C,base64ToBase64Url(a))}if(n&&(r.searchParams.delete(R),r.searchParams.delete(L),n.size!==0)){const a=Array.from(n).map(i=>i.join("-")).join("|");if(a.length>O){const i=E.compressToBase64(a);r.searchParams.set(R,base64ToBase64Url(i))}else{const i=btoa(a);r.searchParams.set(L,base64ToBase64Url(i))}}return r}l(addValuesToUrl,"addValuesToUrl");export function getValuesFromUrl(e){const t=new URLSearchParams(e);let n="",o=new Set;const r=t.get(G)||"",a=t.get(N),i=t.get(C);if(a){const u=E.decompressFromBase64(base64UrlToBase64(a));if(u===null)throw new Error("Decompression failed");n=u}else i&&(n=atob(base64UrlToBase64(i)));const s=t.get(R),c=t.get(L);let d;if(s){const u=E.decompressFromBase64(base64UrlToBase64(s));if(u===null)throw new Error("Decompression failed");d=u}else c&&(d=atob(base64UrlToBase64(c)));return d&&(o=new Set(d.split("|").map(u=>u.split("-").map(Number)))),[n,o,r]}l(getValuesFromUrl,"getValuesFromUrl");export function filterInvalidPaths(e,t){const n=new Set,o=Array.from(_.fromString(e).getAllNtsPaths());for(const r of t)o.some(a=>a.every((i,s)=>i===r[s]))&&n.add(r);return n}l(filterInvalidPaths,"filterInvalidPaths");function I(e){return new Promise((t,n)=>{var o;const r=(o=document.querySelector("textarea[name=ebnf_grammar]"))===null||o===void 0?void 0:o.value;r.trim()===""&&(console.debug("Nothing was entered into the textarea."),n("No grammar to visualize")),asyncString2Diagram(r).then(a=>{let i=a.toSvg(e);const s=['xmlns="http://www.w3.org/2000/svg"','shape-rendering="geometricPrecision"','text-rendering="geometricPrecision"','image-rendering="optimizeQuality"'];i=i.replace("<svg",`<svg ${s.join(" ")}`);const c=document.styleSheets[0];asyncCss2String(c).then(d=>{i=i.replace("</defs>",`<style>${d}</style></defs>`),t(i)}).catch(d=>{n(d)})})})}l(I,"getSvg");export function exportSvg(e){return g(this,void 0,void 0,function*(){const t=document.querySelector("#export-as-svg");F(t),I(e).then(n=>{const o=new Blob([n],{type:"image/svg+xml"}),r=URL.createObjectURL(o),a=document.createElement("a");a.href=r,a.download="railroad-diagram.svg",a.click(),URL.revokeObjectURL(r),D(t)})})}l(exportSvg,"exportSvg");export function exportPng(e){return g(this,void 0,void 0,function*(){const t=document.querySelector("#export-as-png");F(t),I(e).then(n=>{var o,r;const a=parseFloat(((o=n.match(/width="([^"]+)"/))===null||o===void 0?void 0:o[1])||"0"),i=parseFloat(((r=n.match(/height="([^"]+)"/))===null||r===void 0?void 0:r[1])||"0"),s=a/i,c=a>i?a*A:i*A*s,d=a>i?a*A/s:i*A;console.debug(`Scaled SVG to ${c}x${d}px for PNG export.`);const u=n.replace(`width="${a}"`,`width="${c}"`).replace(`height="${i}"`,`height="${d}"`),h=new Blob([u],{type:"image/svg+xml;charset=utf-8"}),k=URL.createObjectURL(h),w=new Image;w.src=k,w.onload=function(){const S=document.createElement("canvas");S.width=c,S.height=d;const B=S.getContext("2d");if(!B){console.error("Canvas not supported");return}B.drawImage(w,0,0);const $=S.toDataURL("image/png"),P=document.createElement("a");P.href=$,P.download="railroad-diagram.png",P.click(),URL.revokeObjectURL($),D(t)},w.onerror=function(){console.error("Error loading SVG image"),console.log(w.src),D(t)}}).catch(n=>{console.error(n)})})}l(exportPng,"exportPng");function F(e){e.style.cursor="wait",e.disabled=!0}l(F,"buttonPressLoad");function D(e){e.style.cursor="default",e.disabled=!1}l(D,"buttonPressReset");function f(e){const t=document.querySelector("textarea[name=ebnf_grammar]");t&&window.history.replaceState({},"",addValuesToUrl(window.location.href,t.value,window.toExtend,e))}l(f,"updateUrl");function te(){const e=document.getElementsByClassName("railroad-diagram")[0];if(!e)return;const t=document.getElementsByClassName("flex-container")[0].children,n=Array.from(t).slice(0,t.length-1).reduce((r,a)=>r+a.clientHeight,0),o=window.innerHeight-n;e.parentElement&&e.setAttribute("viewBox",`0 0 ${e.parentElement.offsetWidth} ${o}`)}l(te,"updateSvgViewBoxSize");export function setStartSymbols(e,t){if(!T){console.warn("Failed to find start symbol drop down.");return}if(e.length===0){T.style.display="none";return}const n=e[0];e.sort(),e=e.sort();const o=document.querySelector("#start-symbol");if(!o){console.warn("Failed to find start symbol select.");return}if(o.options.length===e.length){let r=!0;for(let a=0;a<e.length;a++)if(o.options[a].value!==e[a]){r=!1;break}if(r)return}return console.debug("Updating start symbols in dropdown."),o.innerHTML="",e.forEach(r=>{const a=document.createElement("option");a.value=r,a.text=r,o.appendChild(a)}),T.style.display="block",e.includes(t)?(o.value=t,t):(o.value=n,f(n),n)}l(setStartSymbols,"setStartSymbols");function H(){const e=document.querySelector("#start-symbol");if(e==null)throw new Error("Failed to find start symbol select.");const t=e.value;t!==window.currentStartSymbolName&&(window.currentStartSymbolName=t,window.toExtend.clear(),console.debug(`Setting start symbol to '${t}' and creating new diagram.`),m(),f())}l(H,"handleStartSymbolSelection");
