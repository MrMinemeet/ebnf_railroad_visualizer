"use strict";var f=function(e,t,n,o){function r(a){return a instanceof n?a:new n(function(i){i(a)})}return new(n||(n=Promise))(function(a,i){function l(d){try{c(o.next(d))}catch(p){i(p)}}function s(d){try{c(o.throw(d))}catch(p){i(p)}}function c(d){d.done?a(d.value):r(d.value).then(l,s)}c((o=o.apply(e,t||[])).next())})};import{Diagram as P}from"./Diagram.js";import{Grammar as k}from"./Grammar.js";import*as S from"https://cdn.jsdelivr.net/npm/d3@7/+esm";import y from"./external/lz-string.js";const $=100,z=100,E=4,_="grammarlz",N="grammar",C="expandlz",R="expand",L="start";let g,w,v,A,G,M,x="",O;export function install(e){let t=document.getElementById("error_message");if(t==null)throw new Error("Failed to find 'error_message' container");if(g=t,t=document.getElementById("visualized-ebnf"),t==null)throw new Error("Failed to find 'visualized-ebnf' container");if(w=t,t=document.querySelector("textarea[name=ebnf_grammar]"),t==null)throw new Error("Failed to find 'ebnf_grammar' textarea");if(v=t,t=document.querySelector("#start-symbol"),t==null)throw new Error("Failed to find 'start-symbol' select");G=t,A=document.querySelector(".start-symbol-drop-down"),e.currentStartSymbolName="",e.toExtend=new Set,e.generateDiagram=u,e.handleGenerateDiagram=V,e.handleStartSymbolSelection=F,e.onCollapseAll=X,e.onExpandAll=W,e.exportSvg=()=>exportSvg(e.toExtend),e.exportPng=()=>exportPng(e.toExtend),e.addEventListener("resize",e.updateSvgViewBoxSize)}function j(){var e;if(x.trim().length===0)return;const t=S.select(".railroad-diagram");let n=Array.from((e=t.node())===null||e===void 0?void 0:e.querySelectorAll("title")).filter(s=>s.innerHTML===x)[0].parentNode;if(n==null)throw new Error("Failed to find parent of focus element");n.tagName==="g"&&n.classList.contains("comment")&&(n=n.parentNode);const o=n.getBBox(),r=o.x+o.width/2,a=o.y+o.height/2,i=t.node().viewBox.baseVal,l=S.zoomIdentity.translate(i.width/2-r,i.height/2-a);console.debug(`Box center: (${r}, ${a})`),console.debug(`New transform: ${l}`),t.call(M.transform,l),x=""}function V(){u(),m(),Z()}function X(){window.toExtend.clear(),u(),m()}function W(){const e=v.value;e.trim()!==""&&(console.debug("Expanding all non-erminals"),asyncString2Diagram(e,window.currentStartSymbolName).then(t=>{window.toExtend=t.getAllNtsPaths(),u(),m()}).catch(t=>console.warn(t)))}function Q(){var e;const t=document.getElementsByClassName("railroad-diagram")[0];t.removeAttribute("width"),t.removeAttribute("height"),J();const n=S.select(".railroad-diagram"),o=Array.from((e=n.node())===null||e===void 0?void 0:e.children),r=n.append("g");o.forEach(i=>{var l;(l=r.node())===null||l===void 0||l.appendChild(i)}),M=S.zoom().scaleExtent([.1,8]).on("zoom",a),n.call(M);function a({transform:i}){r.attr("transform",i.toString())}}function u(){if(v.value.trim()===""){console.debug("Nothing was entered into the textarea."),w.style.display="none";return}const e=v.value,t=getNonAsciiChars(e);if(t.size>0){console.warn("The following non-ASCII characters were detected in the grammar: ",t),g.innerHTML=`<p>Non-ASCII character(s) detected: ${Array.from(t).join(", ")}</p>`,g.style.display="block",w.style.display="none";return}asyncString2Grammar(e).then(n=>(window.currentStartSymbolName=setStartSymbols(n.getStartSymbols(),window.currentStartSymbolName)||"",asyncGrammar2Diagram(n,window.currentStartSymbolName))).then(n=>{w.innerHTML=n.toSvg(window.toExtend),Q(),document.querySelectorAll(".non-terminal").forEach(o=>Y(o)),document.querySelectorAll("g.comment").forEach(o=>K(o)),j(),g.style.display="none"}).catch(n=>{const o=/^Production '([^']*)' not found, but required for expansion$/;console.warn(`An error occurred while generating the diagram: ${n}`),!n.message.includes("but found")&&!n.message.includes("Unknown character")&&!o.test(n.message)&&console.warn(n.stack),g.innerHTML=`<p>${n}</p>`,g.style.display="block",o.test(n.message)||(w.innerHTML="")})}function Y(e){e.addEventListener("click",t=>{var n,o,r,a,i,l;if(t.currentTarget==null){console.warn("Failed to find current target.");return}if(t.ctrlKey){const s=(o=(n=t.currentTarget.querySelector("text"))===null||n===void 0?void 0:n.textContent)!==null&&o!==void 0?o:"";if(G==null){console.warn("Failed to find start symbol select.");return}G.value=s,F()}else{const s=t.currentTarget.querySelector("title"),c=(a=(r=s?.textContent)===null||r===void 0?void 0:r.trim())!==null&&a!==void 0?a:"",d=title2Path(c);if(d.length>=P.MAX_EXPANSION_DEPTH){console.warn(`Cannot expand NTS on path '${c}'. Depth limit reached!`),alert("Max. expansion depth reached!");return}window.toExtend.add(d),console.debug(`Expanding NTS on path '${c}'`),x=(l=(i=t.currentTarget.querySelector("title"))===null||i===void 0?void 0:i.innerHTML)!==null&&l!==void 0?l:"",u(),m()}})}function K(e){e.addEventListener("click",t=>{var n,o,r,a;const i=t.currentTarget.querySelector("title"),l=(o=(n=i?.textContent)===null||n===void 0?void 0:n.trim())!==null&&o!==void 0?o:"";console.debug(`Collapsing NTS on path '${l}'`),window.toExtend=new Set(Array.from(window.toExtend).filter(s=>s.join("-")!==l)),x=(a=(r=t.currentTarget.querySelector("title"))===null||r===void 0?void 0:r.innerHTML)!==null&&a!==void 0?a:"",u(),m()})}function Z(){clearTimeout(O),O=setTimeout(()=>{try{const e=window.toExtend.size;window.toExtend=filterInvalidPaths(v.value,window.toExtend),e!==window.toExtend.size?(console.debug(`Cleaned up ${e-window.toExtend.size} paths`),u(),m()):console.debug("No paths to clean up")}catch(e){console.warn(`An error occurred while cleaning up paths (this can likely be ignored): ${e}`)}},5e3)}export function isUppercase(e){return/^\p{Lu}/u.test(e)}export function isQuote(e){return e==='"'||e==="\u201E"||e==="\u201C"}export function asyncString2Diagram(e,t){return f(this,void 0,void 0,function*(){return console.debug("Generating diagram\u2026"),new Promise((n,o)=>{asyncString2Grammar(e).then(r=>{n(asyncGrammar2Diagram(r,t))}).catch(o)})})}export function asyncGrammar2Diagram(e,t){return f(this,void 0,void 0,function*(){return console.debug("Generating diagram\u2026"),new Promise((n,o)=>{const r=setTimeout(()=>{console.debug("Generation Timeout"),o()},$);try{const a=P.fromGrammar(e,t);console.debug("Diagram generated successfully."),clearTimeout(r),n(a)}catch(a){clearTimeout(r),o(a)}})})}export function asyncString2Grammar(e){return f(this,void 0,void 0,function*(){return console.debug("Scanning/Parsing grammar"),new Promise((t,n)=>{const o=setTimeout(()=>{console.debug("Generation Timeout"),n()},$);try{const r=k.fromString(e);console.debug("Grammar scanned/parsed successfully."),clearTimeout(o),t(r)}catch(r){clearTimeout(o),n(r)}})})}export function asyncCss2String(e){return f(this,void 0,void 0,function*(){return new Promise((t,n)=>{try{t(Array.from(e.cssRules).map(o=>o.cssText).filter(o=>!o.includes("hover")).join(`
`))}catch(o){n(o)}})})}export function base64ToBase64Url(e){return e.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}export function base64UrlToBase64(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");for(;t.length%4!==0;)t+="=";return t}export function getNonAsciiChars(e,t=!1){return new Set(e.split("").filter(n=>n.charCodeAt(0)>(t?255:127)))}export function title2Path(e){return e.split("-").map(Number)}export function addValuesToUrl(e,t,n,o){const r=new URL(e);if(o&&o.trim()!==""&&(r.searchParams.delete(L),o.trim()!==""&&r.searchParams.set(L,o)),t&&(r.searchParams.delete(_),r.searchParams.delete(N),t.trim()!==""))if(t.length>z){const a=y.compressToBase64(t);r.searchParams.set(_,base64ToBase64Url(a))}else{const a=btoa(t);r.searchParams.set(N,base64ToBase64Url(a))}if(n&&(r.searchParams.delete(C),r.searchParams.delete(R),n.size!==0)){const a=Array.from(n).map(i=>i.join("-")).join("|");if(a.length>z){const i=y.compressToBase64(a);r.searchParams.set(C,base64ToBase64Url(i))}else{const i=btoa(a);r.searchParams.set(R,base64ToBase64Url(i))}}return r}export function getValuesFromUrl(e){const t=new URLSearchParams(e);let n="",o=new Set;const r=t.get(L)||"",a=t.get(_),i=t.get(N);if(a){const d=y.decompressFromBase64(base64UrlToBase64(a));if(d===null)throw new Error("Decompression failed");n=d}else i&&(n=atob(base64UrlToBase64(i)));const l=t.get(C),s=t.get(R);let c;if(l){const d=y.decompressFromBase64(base64UrlToBase64(l));if(d===null)throw new Error("Decompression failed");c=d}else s&&(c=atob(base64UrlToBase64(s)));return c&&(o=new Set(c.split("|").map(d=>d.split("-").map(Number)))),[n,o,r]}export function filterInvalidPaths(e,t){const n=new Set,o=Array.from(P.fromString(e).getAllNtsPaths());for(const r of t)o.some(a=>a.every((i,l)=>i===r[l]))&&n.add(r);return n}function q(e){return new Promise((t,n)=>{var o;const r=(o=document.querySelector("textarea[name=ebnf_grammar]"))===null||o===void 0?void 0:o.value;r.trim()===""&&(console.debug("Nothing was entered into the textarea."),n("No grammar to visualize")),asyncString2Diagram(r).then(a=>{let i=a.toSvg(e);const l=['xmlns="http://www.w3.org/2000/svg"','shape-rendering="geometricPrecision"','text-rendering="geometricPrecision"','image-rendering="optimizeQuality"'];i=i.replace("<svg",`<svg ${l.join(" ")}`);const s=document.styleSheets[0];asyncCss2String(s).then(c=>{i=i.replace("</defs>",`<style>${c}</style></defs>`),t(i)}).catch(c=>{n(c)})})})}export function exportSvg(e){return f(this,void 0,void 0,function*(){const t=document.querySelector("#export-as-svg");I(t),q(e).then(n=>{const o=new Blob([n],{type:"image/svg+xml"}),r=URL.createObjectURL(o),a=document.createElement("a");a.href=r,a.download="railroad-diagram.svg",a.click(),URL.revokeObjectURL(r),U(t)})})}export function exportPng(e){return f(this,void 0,void 0,function*(){const t=document.querySelector("#export-as-png");I(t),q(e).then(n=>{var o,r;const a=parseFloat(((o=n.match(/width="([^"]+)"/))===null||o===void 0?void 0:o[1])||"0"),i=parseFloat(((r=n.match(/height="([^"]+)"/))===null||r===void 0?void 0:r[1])||"0"),l=a/i,s=a>i?a*E:i*E*l,c=a>i?a*E/l:i*E;console.debug(`Scaled SVG to ${s}x${c}px for PNG export.`);const d=n.replace(`width="${a}"`,`width="${s}"`).replace(`height="${i}"`,`height="${c}"`),p=new Blob([d],{type:"image/svg+xml;charset=utf-8"}),H=URL.createObjectURL(p),h=new Image;h.src=H,h.onload=function(){const b=document.createElement("canvas");b.width=s,b.height=c;const D=b.getContext("2d");if(!D){console.error("Canvas not supported");return}D.drawImage(h,0,0);const B=b.toDataURL("image/png"),T=document.createElement("a");T.href=B,T.download="railroad-diagram.png",T.click(),URL.revokeObjectURL(B),U(t)},h.onerror=function(){console.error("Error loading SVG image"),console.log(h.src),U(t)}}).catch(n=>{console.error(n)})})}function I(e){e.style.cursor="wait",e.disabled=!0}function U(e){e.style.cursor="default",e.disabled=!1}function m(e){const t=document.querySelector("textarea[name=ebnf_grammar]");t&&window.history.replaceState({},"",addValuesToUrl(window.location.href,t.value,window.toExtend,e))}function J(){const e=document.getElementsByClassName("railroad-diagram")[0];if(!e)return;const t=document.getElementsByClassName("flex-container")[0].children,n=Array.from(t).slice(0,t.length-1).reduce((r,a)=>r+a.clientHeight,0),o=window.innerHeight-n;e.parentElement&&e.setAttribute("viewBox",`0 0 ${e.parentElement.offsetWidth} ${o}`)}export function setStartSymbols(e,t){if(!A){console.warn("Failed to find start symbol drop down.");return}if(e.length===0){A.style.display="none";return}const n=e[0];e.sort(),e=e.sort();const o=document.querySelector("#start-symbol");if(!o){console.warn("Failed to find start symbol select.");return}if(o.options.length===e.length){let r=!0;for(let a=0;a<e.length;a++)if(o.options[a].value!==e[a]){r=!1;break}if(r)return}return console.debug("Updating start symbols in dropdown."),o.innerHTML="",e.forEach(r=>{const a=document.createElement("option");a.value=r,a.text=r,o.appendChild(a)}),A.style.display="block",e.includes(t)?(o.value=t,t):(o.value=n,m(n),n)}function F(){const e=document.querySelector("#start-symbol");if(e==null)throw new Error("Failed to find start symbol select.");const t=e.value;t!==window.currentStartSymbolName&&(window.currentStartSymbolName=t,window.toExtend.clear(),console.debug(`Setting start symbol to '${t}' and creating new diagram.`),u(),m())}
