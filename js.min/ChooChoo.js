"use strict";var W=Object.defineProperty;var s=(e,t)=>W(e,"name",{value:t,configurable:!0});import{Diagram as C}from"./Diagram.js";import{Grammar as Y}from"./Grammar.js";import w from"./external/lz-string.js";const O=100,q=100,A=4,R="grammarlz",L="grammar",G="expandlz",M="expand",U="start";let f,p,S,y,v,_,D,x="",I,l;export function install(e,t){let n=document.getElementById("error_message");if(n==null)throw new Error("Failed to find 'error_message' container");if(p=n,n=document.getElementById("visualized-ebnf"),n==null)throw new Error("Failed to find 'visualized-ebnf' container");if(S=n,n=document.querySelector("textarea[name=ebnf_grammar]"),n==null)throw new Error("Failed to find 'ebnf_grammar' textarea");if(y=n,n=document.querySelector("#start-symbol"),n==null)throw new Error("Failed to find 'start-symbol' select");_=n,v=document.querySelector(".start-symbol-drop-down"),t==null&&console.warn("d3 not provided. Will not be able to zoom."),f=t,e.generateDiagram=u,e.handleGenerateDiagram=Q,e.handleStartSymbolSelection=X,e.onCollapseAll=Z,e.onExpandAll=J,e.exportSvg=()=>exportSvg(),e.exportPng=()=>exportPng(),e.addEventListener("resize",e.updateSvgViewBoxSize),e.chooChoo=l={toExtend:new Set,currentStartSymbolName:""}}s(install,"install");function K(){if(f==null||x.trim().length===0)return;const e=f.select(".railroad-diagram");let t=Array.from(e.node()?.querySelectorAll("title")).filter(i=>i.innerHTML===x)[0].parentNode;if(t==null)throw new Error("Failed to find parent of focus element");t.tagName==="g"&&t.classList.contains("comment")&&(t=t.parentNode);const n=t.getBBox(),r=n.x+n.width/2,o=n.y+n.height/2,a=e.node().viewBox.baseVal,c=f.zoomIdentity.translate(a.width/2-r,a.height/2-o);console.debug(`Box center: (${r}, ${o})`),console.debug(`New transform: ${c}`),e.call(D.transform,c),x=""}s(K,"focusElementSvg");function Q(){u(),g(),re()}s(Q,"handleGenerateDiagram");function Z(){l.toExtend.clear(),u(),g()}s(Z,"onCollapseAll");function J(){const e=y.value;e.trim()!==""&&(console.debug("Expanding all non-erminals"),F(e,l.currentStartSymbolName).then(t=>{l.toExtend=t.getAllNtsPaths(),u(),g()}).catch(t=>console.warn(t)))}s(J,"onExpandAll");function ee(){if(f==null)return;const e=document.getElementsByClassName("railroad-diagram")[0];e.removeAttribute("width"),e.removeAttribute("height"),ie();const t=f.select(".railroad-diagram"),n=Array.from(t.node()?.children),r=t.append("g");n.forEach(a=>{r.node()?.appendChild(a)}),D=f.zoom().scaleExtent([.1,8]).on("zoom",o),t.call(D);function o({transform:a}){r.attr("transform",a.toString())}s(o,"zoomed")}s(ee,"injectD3");function u(){if(y.value.trim()===""){console.debug("Nothing was entered into the textarea."),S.style.display="none";return}const e=y.value,t=ae(e);if(t.size>0){console.warn("The following non-ASCII characters were detected in the grammar: ",t),p.innerHTML=`<p>Non-ASCII character(s) detected: ${Array.from(t).join(", ")}</p>`,p.style.display="block",S.style.display="none";return}k(e).then(n=>(l.currentStartSymbolName=me(n.getStartSymbols(),l.currentStartSymbolName)||"",H(n,l.currentStartSymbolName))).then(n=>{S.innerHTML=n.toSvg(l.toExtend),ee(),document.querySelectorAll(".non-terminal").forEach(r=>te(r)),document.querySelectorAll("g.comment").forEach(r=>ne(r)),K(),p.style.display="none"}).catch(n=>{const r=/^Production '([^']*)' not found, but required for expansion$/;console.warn(`An error occurred while generating the diagram: ${n}`),!n.message.includes("but found")&&!n.message.includes("Unknown character")&&!r.test(n.message)&&console.warn(n.stack),p.innerHTML=`<p>${n}</p>`,p.style.display="block",r.test(n.message)||(S.innerHTML="")})}s(u,"generateDiagram");function te(e){e.addEventListener("click",t=>{if(t.currentTarget==null){console.warn("Failed to find current target.");return}if(t.ctrlKey){const n=t.currentTarget.querySelector("text")?.textContent??"";if(_==null){console.warn("Failed to find start symbol select.");return}_.value=n,X()}else{const r=t.currentTarget.querySelector("title")?.textContent?.trim()??"",o=se(r);if(o.length>=C.MAX_EXPANSION_DEPTH){console.warn(`Cannot expand NTS on path '${r}'. Depth limit reached!`),alert("Max. expansion depth reached!");return}l.toExtend.add(o),console.debug(`Expanding NTS on path '${r}'`),x=t.currentTarget.querySelector("title")?.innerHTML??"",u(),g()}})}s(te,"injectCollapseListener");function ne(e){e.addEventListener("click",t=>{const r=t.currentTarget.querySelector("title")?.textContent?.trim()??"";console.debug(`Collapsing NTS on path '${r}'`),l.toExtend=new Set(Array.from(l.toExtend).filter(o=>o.join("-")!==r)),x=t.currentTarget.querySelector("title")?.innerHTML??"",u(),g()})}s(ne,"injectExpandListener");function re(){clearTimeout(I),I=setTimeout(()=>{try{const e=l.toExtend.size;l.toExtend=ce(y.value,l.toExtend),e!==l.toExtend.size?(console.debug(`Cleaned up ${e-l.toExtend.size} paths`),u(),g()):console.debug("No paths to clean up")}catch(e){console.warn(`An error occurred while cleaning up paths (this can likely be ignored): ${e}`)}},5e3)}s(re,"resetPathCleanupTimer");export function isUppercase(e){return/^\p{Lu}/u.test(e)}s(isUppercase,"isUppercase");async function F(e,t){return console.debug("Generating diagram\u2026"),new Promise((n,r)=>{k(e).then(o=>{n(H(o,t))}).catch(r)})}s(F,"asyncString2Diagram");async function H(e,t){return console.debug("Generating diagram\u2026"),new Promise((n,r)=>{const o=setTimeout(()=>{console.debug("Generation Timeout"),r()},O);try{const a=C.fromGrammar(e,t);console.debug("Diagram generated successfully."),clearTimeout(o),n(a)}catch(a){clearTimeout(o),r(a)}})}s(H,"asyncGrammar2Diagram");async function k(e){return console.debug("Scanning/Parsing grammar"),new Promise((t,n)=>{const r=setTimeout(()=>{console.debug("Generation Timeout"),n()},O);try{const o=Y.fromString(e);console.debug("Grammar scanned/parsed successfully."),clearTimeout(r),t(o)}catch(o){clearTimeout(r),n(o)}})}s(k,"asyncString2Grammar");async function oe(e){return new Promise((t,n)=>{try{t(Array.from(e.cssRules).map(r=>r.cssText).filter(r=>!r.includes("hover")).join(`
`))}catch(r){n(r)}})}s(oe,"asyncCss2String");function P(e){return e.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}s(P,"base64ToBase64Url");function T(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");for(;t.length%4!==0;)t+="=";return t}s(T,"base64UrlToBase64");function ae(e,t=!1){return new Set(e.split("").filter(n=>n.charCodeAt(0)>(t?255:127)))}s(ae,"getNonAsciiChars");function se(e){return e.split("-").map(Number)}s(se,"title2Path");function le(e,t,n,r){const o=new URL(e);if(r&&r.trim()!==""&&(o.searchParams.delete(U),r.trim()!==""&&o.searchParams.set(U,r)),t&&(o.searchParams.delete(R),o.searchParams.delete(L),t.trim()!==""))if(t.length>q){const a=w.compressToBase64(t);o.searchParams.set(R,P(a))}else{const a=btoa(t);o.searchParams.set(L,P(a))}if(n&&(o.searchParams.delete(G),o.searchParams.delete(M),n.size!==0)){const a=Array.from(n).map(c=>c.join("-")).join("|");if(a.length>q){const c=w.compressToBase64(a);o.searchParams.set(G,P(c))}else{const c=btoa(a);o.searchParams.set(M,P(c))}}return o}s(le,"addValuesToUrl");export function getValuesFromUrl(e){const t=new URLSearchParams(e);let n="",r=new Set;const o=t.get(U)||"",a=t.get(R),c=t.get(L);if(a){const m=w.decompressFromBase64(T(a));if(m===null)throw new Error("Decompression failed");n=m}else c&&(n=atob(T(c)));const i=t.get(G),d=t.get(M);let h;if(i){const m=w.decompressFromBase64(T(i));if(m===null)throw new Error("Decompression failed");h=m}else d&&(h=atob(T(d)));return h&&(r=new Set(h.split("|").map(m=>m.split("-").map(Number)))),[n,r,o]}s(getValuesFromUrl,"getValuesFromUrl");function ce(e,t){const n=new Set,r=Array.from(C.fromString(e).getAllNtsPaths());for(const o of t)r.some(a=>a.every((c,i)=>c===o[i]))&&n.add(o);return n}s(ce,"filterInvalidPaths");function j(e){return new Promise((t,n)=>{const r=document.querySelector("textarea[name=ebnf_grammar]")?.value;r.trim()===""&&(console.debug("Nothing was entered into the textarea."),n("No grammar to visualize")),F(r,l.currentStartSymbolName).then(o=>{let a=o.toSvg(e);const c=['xmlns="http://www.w3.org/2000/svg"','shape-rendering="geometricPrecision"','text-rendering="geometricPrecision"','image-rendering="optimizeQuality"'];a=a.replace("<svg",`<svg ${c.join(" ")}`);const i=document.styleSheets[0];oe(i).then(d=>{a=a.replace("</defs>",`<style>${d}</style></defs>`),t(a)}).catch(d=>{n(d)})})})}s(j,"getSvg");export async function exportSvg(e){e=e||l.toExtend;const t=document.querySelector("#export-as-svg");V(t),j(e).then(n=>{const r=new Blob([n],{type:"image/svg+xml"}),o=URL.createObjectURL(r),a=document.createElement("a");a.href=o,a.download="railroad-diagram.svg",a.click(),URL.revokeObjectURL(o),B(t)})}s(exportSvg,"exportSvg");export async function exportPng(e){e=e||l.toExtend;const t=document.querySelector("#export-as-png");V(t),j(e).then(n=>{const r=parseFloat(n.match(/width="([^"]+)"/)?.[1]||"0"),o=parseFloat(n.match(/height="([^"]+)"/)?.[1]||"0"),a=r/o,c=r>o?r*A:o*A*a,i=r>o?r*A/a:o*A;console.debug(`Scaled SVG to ${c}x${i}px for PNG export.`);const d=n.replace(`width="${r}"`,`width="${c}"`).replace(`height="${o}"`,`height="${i}"`),h=new Blob([d],{type:"image/svg+xml;charset=utf-8"}),m=URL.createObjectURL(h),b=new Image;b.src=m,b.onload=function(){const E=document.createElement("canvas");E.width=c,E.height=i;const $=E.getContext("2d");if(!$){console.error("Canvas not supported");return}$.drawImage(b,0,0);const z=E.toDataURL("image/png"),N=document.createElement("a");N.href=z,N.download="railroad-diagram.png",N.click(),URL.revokeObjectURL(z),B(t)},b.onerror=function(){console.error("Error loading SVG image"),console.log(b.src),B(t)}}).catch(n=>{console.error(n)})}s(exportPng,"exportPng");function V(e){e.style.cursor="wait",e.disabled=!0}s(V,"buttonPressLoad");function B(e){e.style.cursor="default",e.disabled=!1}s(B,"buttonPressReset");function g(e){const t=document.querySelector("textarea[name=ebnf_grammar]");t&&window.history.replaceState({},"",le(location.href,t.value,l.toExtend,e??l.currentStartSymbolName))}s(g,"updateUrl");function ie(){const e=document.getElementsByClassName("railroad-diagram")[0];if(!e)return;const t=document.getElementsByClassName("flex-container")[0].children,n=Array.from(t).slice(0,t.length-1).reduce((o,a)=>o+a.clientHeight,0),r=window.innerHeight-n;e.parentElement&&e.setAttribute("viewBox",`0 0 ${e.parentElement.offsetWidth} ${r}`)}s(ie,"updateSvgViewBoxSize");function me(e,t){if(!v){console.warn("Failed to find start symbol drop down.");return}if(e.length===0){v.style.display="none",console.warn("Start symbol selection is of size 0");return}const n=e[0];e.sort(),e=e.sort();const r=document.querySelector("#start-symbol");if(!r){console.warn("Failed to find start symbol select.");return}if(r.options.length===e.length){let o=!0;for(let a=0;a<e.length;a++)if(r.options[a].value!==e[a]){o=!1;break}if(o)return t}return console.debug("Updating start symbols in dropdown."),r.innerHTML="",e.forEach(o=>{const a=document.createElement("option");a.value=o,a.text=o,r.appendChild(a)}),v.style.display="block",e.includes(t)?(r.value=t,t):(r.value=n,g(n),n)}s(me,"setStartSymbols");function X(){const e=document.querySelector("#start-symbol");if(e==null)throw new Error("Failed to find start symbol select.");const t=e.value;t!==l.currentStartSymbolName&&(console.debug(`Setting start symbol to '${l.currentStartSymbolName}' and creating new diagram.`),l.currentStartSymbolName=t,l.toExtend.clear(),u(),g())}s(X,"handleStartSymbolSelection");
