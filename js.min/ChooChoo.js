"use strict";var Q=Object.defineProperty;var s=(e,t)=>Q(e,"name",{value:t,configurable:!0});import{Diagram as C}from"./Diagram.js";import{Grammar as J}from"./Grammar.js";import{compressAndEncode as B,decodeAndDecompress as F}from"./Compressor.js";const O=100,I=100,A=4,q="grammarlz",L="grammargzip",R="grammar",H="expandlz",N="expandlz",G="expand",z="start";let h,p,y,S,P,_,M,w="",k,l;export function install(e,t){let n=document.getElementById("error_message");if(n==null)throw new Error("Failed to find 'error_message' container");if(p=n,n=document.getElementById("visualized-ebnf"),n==null)throw new Error("Failed to find 'visualized-ebnf' container");if(y=n,n=document.querySelector("textarea[name=ebnf_grammar]"),n==null)throw new Error("Failed to find 'ebnf_grammar' textarea");if(S=n,n=document.querySelector("#start-symbol"),n==null)throw new Error("Failed to find 'start-symbol' select");_=n,P=document.querySelector(".start-symbol-drop-down"),t==null&&console.warn("d3 not provided. Will not be able to zoom."),h=t,e.generateDiagram=g,e.handleGenerateDiagram=te,e.handleStartSymbolSelection=Y,e.onCollapseAll=ne,e.onExpandAll=re,e.exportSvg=()=>exportSvg(),e.exportPng=()=>exportPng(),e.addEventListener("resize",e.updateSvgViewBoxSize),e.chooChoo=l={toExtend:new Set,currentStartSymbolName:""}}s(install,"install");function ee(){if(h==null||w.trim().length===0)return;const e=h.select(".railroad-diagram");let t=Array.from(e.node()?.querySelectorAll("title")).filter(d=>d.innerHTML===w)[0].parentNode;if(t==null)throw new Error("Failed to find parent of focus element");t.tagName==="g"&&t.classList.contains("comment")&&(t=t.parentNode);const n=t.getBBox(),r=n.x+n.width/2,o=n.y+n.height/2,a=e.node().viewBox.baseVal,i=h.zoomIdentity.translate(a.width/2-r,a.height/2-o);console.debug(`Box center: (${r}, ${o})`),console.debug(`New transform: ${i}`),e.call(M.transform,i),w=""}s(ee,"focusElementSvg");function te(){g(),f(),le()}s(te,"handleGenerateDiagram");function ne(){l.toExtend.clear(),g(),f()}s(ne,"onCollapseAll");function re(){const e=S.value;e.trim()!==""&&(console.debug("Expanding all non-erminals"),j(e,l.currentStartSymbolName).then(t=>{l.toExtend=t.getAllNtsPaths(),g(),f()}).catch(t=>console.warn(t)))}s(re,"onExpandAll");function oe(){if(h==null)return;const e=document.getElementsByClassName("railroad-diagram")[0];e.removeAttribute("width"),e.removeAttribute("height"),ge();const t=h.select(".railroad-diagram"),n=Array.from(t.node()?.children),r=t.append("g");n.forEach(a=>{r.node()?.appendChild(a)}),M=h.zoom().scaleExtent([.1,8]).on("zoom",o),t.call(M);function o({transform:a}){r.attr("transform",a.toString())}s(o,"zoomed")}s(oe,"injectD3");function g(){if(S.value.trim()===""){console.debug("Nothing was entered into the textarea."),y.style.display="none";return}const e=S.value,t=ie(e);if(t.size>0){console.warn("The following non-ASCII characters were detected in the grammar: ",t),p.innerHTML=`<p>Non-ASCII character(s) detected: ${Array.from(t).join(", ")}</p>`,p.style.display="block",y.style.display="none";return}X(e).then(n=>(l.currentStartSymbolName=fe(n.getStartSymbols(),l.currentStartSymbolName)||"",V(n,l.currentStartSymbolName))).then(n=>{y.innerHTML=n.toSvg(l.toExtend),oe(),document.querySelectorAll(".non-terminal").forEach(r=>ae(r)),document.querySelectorAll("g.comment").forEach(r=>se(r)),ee(),p.style.display="none"}).catch(n=>{const r=/^Production '([^']*)' not found, but required for expansion$/;console.warn(`An error occurred while generating the diagram: ${n}`),!n.message.includes("but found")&&!n.message.includes("Unknown character")&&!r.test(n.message)&&console.warn(n.stack),p.innerHTML=`<p>${n}</p>`,p.style.display="block",r.test(n.message)||(y.innerHTML="")})}s(g,"generateDiagram");function ae(e){e.addEventListener("click",t=>{if(t.currentTarget==null){console.warn("Failed to find current target.");return}if(t.ctrlKey){const n=t.currentTarget.querySelector("text")?.textContent??"";if(_==null){console.warn("Failed to find start symbol select.");return}_.value=n,Y()}else{const r=t.currentTarget.querySelector("title")?.textContent?.trim()??"",o=de(r);if(o.length>=C.MAX_EXPANSION_DEPTH){console.warn(`Cannot expand NTS on path '${r}'. Depth limit reached!`),alert("Max. expansion depth reached!");return}l.toExtend.add(o),console.debug(`Expanding NTS on path '${r}'`),w=t.currentTarget.querySelector("title")?.innerHTML??"",g(),f()}})}s(ae,"injectCollapseListener");function se(e){e.addEventListener("click",t=>{const r=t.currentTarget.querySelector("title")?.textContent?.trim()??"";console.debug(`Collapsing NTS on path '${r}'`),l.toExtend=new Set(Array.from(l.toExtend).filter(o=>o.join("-")!==r)),w=t.currentTarget.querySelector("title")?.innerHTML??"",g(),f()})}s(se,"injectExpandListener");function le(){clearTimeout(k),k=setTimeout(()=>{try{const e=l.toExtend.size;l.toExtend=ue(S.value,l.toExtend),e!==l.toExtend.size?(console.debug(`Cleaned up ${e-l.toExtend.size} paths`),g(),f()):console.debug("No paths to clean up")}catch(e){console.warn(`An error occurred while cleaning up paths (this can likely be ignored): ${e}`)}},5e3)}s(le,"resetPathCleanupTimer");export function isUppercase(e){return/^\p{Lu}/u.test(e)}s(isUppercase,"isUppercase");async function j(e,t){return console.debug("Generating diagram\u2026"),new Promise((n,r)=>{X(e).then(o=>{n(V(o,t))}).catch(r)})}s(j,"asyncString2Diagram");async function V(e,t){return console.debug("Generating diagram\u2026"),new Promise((n,r)=>{const o=setTimeout(()=>{console.debug("Generation Timeout"),r()},O);try{const a=C.fromGrammar(e,t);console.debug("Diagram generated successfully."),clearTimeout(o),n(a)}catch(a){clearTimeout(o),r(a)}})}s(V,"asyncGrammar2Diagram");async function X(e){return console.debug("Scanning/Parsing grammar"),new Promise((t,n)=>{const r=setTimeout(()=>{console.debug("Generation Timeout"),n()},O);try{const o=J.fromString(e);console.debug("Grammar scanned/parsed successfully."),clearTimeout(r),t(o)}catch(o){clearTimeout(r),n(o)}})}s(X,"asyncString2Grammar");async function ce(e){return new Promise((t,n)=>{try{t(Array.from(e.cssRules).map(r=>r.cssText).filter(r=>!r.includes("hover")).join(`
`))}catch(r){n(r)}})}s(ce,"asyncCss2String");function v(e){return e.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}s(v,"base64ToBase64Url");function b(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");for(;t.length%4!==0;)t+="=";return t}s(b,"base64UrlToBase64");function ie(e,t=!1){return new Set(e.split("").filter(n=>n.charCodeAt(0)>(t?255:127)))}s(ie,"getNonAsciiChars");function de(e){return e.split("-").map(Number)}s(de,"title2Path");async function me(e,t,n,r){const o=new URL(e);if(r&&r.trim()!==""&&(o.searchParams.delete(z),r.trim()!==""&&o.searchParams.set(z,r)),t&&(o.searchParams.delete(q),o.searchParams.delete(L),o.searchParams.delete(R),t.trim()!==""))if(t.length>I){const a=await B(t);o.searchParams.set(L,v(a))}else{const a=btoa(t);o.searchParams.set(R,v(a))}if(n&&(o.searchParams.delete(H),o.searchParams.delete(N),o.searchParams.delete(G),n.size!==0)){const a=Array.from(n).map(i=>i.join("-")).join("|");if(a.length>I){const i=await B(a);debugger;o.searchParams.set(N,v(i))}else{const i=btoa(a);o.searchParams.set(G,v(i))}}return o}s(me,"addValuesToUrl");export async function getValuesFromUrl(e){const t=new URLSearchParams(e);let n=new Set;const r=t.get(z)||"",o=t.get(L),a=t.get(q),i=t.get(R);let d="";if(o){console.debug("Fetching grammar from Gzip");try{d=await F(b(o))}catch(c){console.error("Decompression failed!",c)}}else if(a){console.debug("Falling back to old compression library");try{await K();const c=window.LZString?.decompressFromBase64(b(a));if(c==null)throw new Error("Decompression failed!");d=c}catch(c){console.error("URL uses old compression library, but the library could not be loaded!",c)}}else i&&(d=atob(b(i)));const u=t.get(N),x=t.get(H),E=t.get(G);let m;if(u){console.debug("Fetching expanded paths from Gzip");try{m=await F(b(u))}catch(c){console.error("Decompression failed!",c)}}else if(x){console.warn("Falling back to old compression library");try{window.LZString==null&&await K();const c=window.LZString?.decompressFromBase64(b(x));if(c==null)throw new Error("Decompression failed");m=c}catch(c){console.error("URL uses old compression library, but the library could not be loaded!",c)}}else E&&(m=atob(b(E)));return m&&(n=new Set(m.split("|").map(c=>c.split("-").map(Number)))),[d,n,r]}s(getValuesFromUrl,"getValuesFromUrl");function ue(e,t){const n=new Set,r=Array.from(C.fromString(e).getAllNtsPaths());for(const o of t)r.some(a=>a.every((i,d)=>i===o[d]))&&n.add(o);return n}s(ue,"filterInvalidPaths");function Z(e){return new Promise((t,n)=>{const r=document.querySelector("textarea[name=ebnf_grammar]")?.value;r.trim()===""&&(console.debug("Nothing was entered into the textarea."),n("No grammar to visualize")),j(r,l.currentStartSymbolName).then(o=>{let a=o.toSvg(e);const i=['xmlns="http://www.w3.org/2000/svg"','shape-rendering="geometricPrecision"','text-rendering="geometricPrecision"','image-rendering="optimizeQuality"'];a=a.replace("<svg",`<svg ${i.join(" ")}`);const d=document.styleSheets[0];ce(d).then(u=>{a=a.replace("</defs>",`<style>${u}</style></defs>`),t(a)}).catch(u=>{n(u)})})})}s(Z,"getSvg");export async function exportSvg(e){e=e||l.toExtend;const t=document.querySelector("#export-as-svg");W(t),Z(e).then(n=>{const r=new Blob([n],{type:"image/svg+xml"}),o=URL.createObjectURL(r),a=document.createElement("a");a.href=o,a.download="railroad-diagram.svg",a.click(),URL.revokeObjectURL(o),D(t)})}s(exportSvg,"exportSvg");export async function exportPng(e){e=e||l.toExtend;const t=document.querySelector("#export-as-png");W(t),Z(e).then(n=>{const r=parseFloat(n.match(/width="([^"]+)"/)?.[1]||"0"),o=parseFloat(n.match(/height="([^"]+)"/)?.[1]||"0"),a=r/o,i=r>o?r*A:o*A*a,d=r>o?r*A/a:o*A;console.debug(`Scaled SVG to ${i}x${d}px for PNG export.`);const u=n.replace(`width="${r}"`,`width="${i}"`).replace(`height="${o}"`,`height="${d}"`),x=new Blob([u],{type:"image/svg+xml;charset=utf-8"}),E=URL.createObjectURL(x),m=new Image;m.src=E,m.onload=function(){const c=document.createElement("canvas");c.width=i,c.height=d;const U=c.getContext("2d");if(!U){console.error("Canvas not supported");return}U.drawImage(m,0,0);const $=c.toDataURL("image/png"),T=document.createElement("a");T.href=$,T.download="railroad-diagram.png",T.click(),URL.revokeObjectURL($),D(t)},m.onerror=function(){console.error("Error loading SVG image"),console.log(m.src),D(t)}}).catch(n=>{console.error(n)})}s(exportPng,"exportPng");function W(e){e.style.cursor="wait",e.disabled=!0}s(W,"buttonPressLoad");function D(e){e.style.cursor="default",e.disabled=!1}s(D,"buttonPressReset");async function f(e){const t=document.querySelector("textarea[name=ebnf_grammar]");if(!t)return;const n=await me(location.href,t.value,l.toExtend,e??l.currentStartSymbolName);window.history.replaceState({},"",n)}s(f,"updateUrl");function ge(){const e=document.getElementsByClassName("railroad-diagram")[0];if(!e)return;const t=document.getElementsByClassName("flex-container")[0].children,n=Array.from(t).slice(0,t.length-1).reduce((o,a)=>o+a.clientHeight,0),r=window.innerHeight-n;e.parentElement&&e.setAttribute("viewBox",`0 0 ${e.parentElement.offsetWidth} ${r}`)}s(ge,"updateSvgViewBoxSize");function fe(e,t){if(!P){console.warn("Failed to find start symbol drop down.");return}if(e.length===0){P.style.display="none",console.warn("Start symbol selection is of size 0");return}const n=e[0];e.sort(),e=e.sort();const r=document.querySelector("#start-symbol");if(!r){console.warn("Failed to find start symbol select.");return}if(r.options.length===e.length){let o=!0;for(let a=0;a<e.length;a++)if(r.options[a].value!==e[a]){o=!1;break}if(o)return t}return console.debug("Updating start symbols in dropdown."),r.innerHTML="",e.forEach(o=>{const a=document.createElement("option");a.value=o,a.text=o,r.appendChild(a)}),P.style.display="block",e.includes(t)?(r.value=t,t):(r.value=n,f(n),n)}s(fe,"setStartSymbols");function Y(){const e=document.querySelector("#start-symbol");if(e==null)throw new Error("Failed to find start symbol select.");const t=e.value;t!==l.currentStartSymbolName&&(console.debug(`Setting start symbol to '${l.currentStartSymbolName}' and creating new diagram.`),l.currentStartSymbolName=t,l.toExtend.clear(),g(),f())}s(Y,"handleStartSymbolSelection");function K(){return console.warn("Loading lz-string dynamically. Consider updating the URL"),new Promise((e,t)=>{const n=document.createElement("script");n.src="https://cdn.jsdelivr.net/gh/pieroxy/lz-string@1.5.0/libs/lz-string.min.js",n.onload=()=>e(),n.onerror=t,document.head.appendChild(n)})}s(K,"fetchLzString");
